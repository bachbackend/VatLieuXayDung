<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý bài viết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Public CDN for TinyMCE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/7.0.0/tinymce.min.js"></script>

    <script>
        // Initialize TinyMCE
        tinymce.init({
            selector: 'textarea', // Apply TinyMCE to all <textarea> elements
            plugins: [
                'anchor', 'autolink', 'charmap', 'codesample', 'emoticons',
                'image', 'link', 'lists', 'media', 'searchreplace',
                'table', 'visualblocks', 'wordcount'
            ],
            toolbar: 'undo redo | bold italic underline | link image media | numlist bullist | emoticons charmap | removeformat',
            branding: false, // Remove "Powered by TinyMCE" branding
            height: 300 // Set editor height
        });
    </script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f6f9;
        }

        .container-fluid {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #4e73df;
            font-weight: 500;
            margin-bottom: 30px;
        }

        .form-control,
        .btn {
            border-radius: 10px;
        }

        .form-control:focus,
        .btn:focus {
            box-shadow: none;
            outline: none;
        }

        .mb-4 {
            margin-bottom: 20px;
        }

        .table {
            width: 100%;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }

        th,
        td {
            padding: 15px;
            text-align: center;
        }

        th {
            background-color: #4e73df;
            color: white;
            font-weight: 500;
        }

        td {
            background-color: #f9f9f9;
        }

        .action-btns button {
            transition: transform 0.2s ease, background-color 0.3s ease;
        }

        .action-btns button:hover {
            transform: scale(1.05);
            background-color: #5a6268;
        }

        .table tr:hover {
            background-color: #f1f1f1;
        }

        .pagination {
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            border-radius: 50%;
            padding: 10px 15px;
            margin: 0 5px;
            transition: background-color 0.3s ease;
        }

        .pagination button:hover {
            background-color: #4e73df;
            color: white;
        }

        .pagination button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }

        .input-group .form-control {
            margin-right: 10px;
        }

        .btn-primary {
            background-color: #4e73df;
            border: none;
        }

        .btn-primary:hover {
            background-color: #365f8f;
        }

        /* Thêm hiệu ứng cho các input khi focus */
        .form-control:focus {
            border-color: #4e73df;
            box-shadow: 0 0 5px rgba(78, 115, 223, 0.5);
        }

        /* Cải tiến bố cục phần filter */
        .filter-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-row .form-control {
            width: 100%;
            max-width: 200px;
        }

        .filter-row .btn-primary {
            width: 100%;
            max-width: 200px;
        }

        /* Chỉnh sửa cột ID */
        th:first-child,
        td:first-child {
            width: 30px;
            /* Điều chỉnh kích thước của cột ID */
            text-align: center;
            /* Căn giữa cột ID */
        }

        th:nth-child(5),
        td:nth-child(5) {
            width: 300px;
            /* Làm cho cột Dịch vụ rộng hơn */
        }

        th:nth-child(6),
        td:nth-child(6) {
            width: 200px;
            /* Làm cho cột Dịch vụ rộng hơn */
        }

        th:nth-child(7),
        td:nth-child(7) {
            width: 220px;
            /* Làm cho cột Hành động rộng hơn */
            text-align: center;
            /* Căn giữa các nút hành động */
        }

        .filter-container {
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .filter-row .form-control,
        .filter-row .btn {
            flex: 1;
        }

        .filter-row select {
            min-width: 200px;
        }

        .col-stt { width: 5%; }
        .col-title { width: 25%; }
        .col-thumbnail { width: 20%; }
        .col-category { width: 20%; }
        .col-status { width: 10%; }
        .col-date { width: 10%; }
        .col-action { width: 10%; }
    </style>
</head>

<body>
    <div class="container-fluid mt-5">
        <h1 class="text-center mb-4">Quản Lý Bài Viết</h1>
        <div class="mb-4 text-right">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCompanyModal">Thêm
                bài viết
            </button>

            <!-- <button type="button" class="btn btn-primary" id="downloadCSVButton">
                Tải File CSV
            </button> -->
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exportCSVModal">Tải
                File CSV
            </button>
        </div>
    </div>

    <!-- Modal CSV-->
    <div class="modal fade" id="exportCSVModal" tabindex="-1" aria-labelledby="exportCSVModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportCSVModalLabel">Tải CSV - Lọc Công Ty Vận Chuyển</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="filterForm">
                        <div class="mb-3">
                            <label for="provinceCSV" class="form-label">Chọn Tỉnh/Thành phố</label>
                            <select class="form-select" id="provinceCSV" name="provinceId">
                                <option value="">Tất cả</option>
                                <!-- Dữ liệu các tỉnh/thành phố sẽ được điền vào đây từ API -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="districtCSV" class="form-label">Chọn Quận/Huyện</label>
                            <select class="form-select" id="districtCSV" name="districtId">
                                <option value="">Tất cả</option>
                                <!-- Dữ liệu các quận/huyện sẽ được điền vào đây từ API -->
                            </select>
                        </div>
                    </form>
                    <button type="button" class="btn btn-primary" id="downloadCSVBtn">Tải File CSV</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal add-->
    <div class="modal fade" id="addCompanyModal" tabindex="-1" aria-labelledby="addCompanyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCompanyModalLabel">Thêm Bài Viết Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addCompanyForm">
                        <div class="mb-3">
                            <label for="articleTitle" class="form-label">Tiêu đề <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="articleTitle" name="Name" required>
                        </div>

                        <div class="mb-3">
                            <label for="articleCategory" class="form-label">Thể loại bài viết <span
                                    class="text-danger">*</span></label>
                            <select class="form-control" id="articleCategory">
                                <option value="">Chọn thể loại bài viết</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="articleContent" class="form-label">Nội dung <span
                                    class="text-danger">*</span></label>
                            <textarea id="articleContent" name="Description"></textarea><br><br>
                        </div>

                        <div class="mb-3">
                            <label for="articleStatus" class="form-label">Trạng thái <span class="text-danger">*</span></label>
                            <select id="articleStatus" name="Status" class="form-control">
                                <option value="0">Hoạt động</option>
                                <option value="1">Bị ẩn</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="articleImage" class="form-label">Upload Image <span
                                    class="text-danger">*</span></label>
                            <input type="file" id="articleImage" name="file" accept="image/*" class="form-control" required>
                        </div>

                        <input type="hidden" id="userId" name="UserId" value="1">

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            <!-- <button type="button" class="btn btn-primary" id="addCompanyBtn">Thêm Công Ty</button> -->
                            <button type="button" class="btn btn-primary" onclick="submitForm()">Thêm bài viết</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal view by id-->
    <div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> <!-- Thêm modal-lg để làm rộng modal -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="companyModalLabel">Thông Tin Bài Viết</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h5 id="modalCompanyName"></h5>
                    <p><strong>Tiêu đề:</strong> <span id="titleById"></span></p>
                    <p><strong>Thể loại bài viết:</strong> <span id="articleCategoryById"></span></p>
                    <p><strong>Nội dung:</strong></p>
                    <textarea id="articleContentById" class="form-control" rows="20" readonly></textarea>
                    <p><strong>Trạng thái:</strong> <span id="statusById"></span></p>
                    <p><strong>Ảnh thumbnail:</strong>
                        <img id="articleThumbnail" src="" alt="Hoàng Thành Thăng Long" class="img-fluid"
                            style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 15px;">
                    </p>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa công ty -->
    <div class="modal fade" id="editCompanyModal" tabindex="-1" aria-labelledby="editCompanyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCompanyModalLabel">Chỉnh Sửa Bài Viết</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCompanyForm">
                        <div class="mb-3">
                            <input type="hidden" class="form-control" id="editArticleId" required>
                        </div>
                        <div class="mb-3">
                            <label for="editArticleTitle" class="form-label">Tiêu đề <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editArticleTitle" required maxlength="250">
                        </div>
                        <div class="mb-3">
                            <label for="editArticleCategory" class="form-label">Thể loại bài viết <span
                                    class="text-danger">*</span></label>
                            <select class="form-control" id="editArticleCategory">
                                <option value="">Chọn thể loại bài viết</option>
                                <!-- Các loại sản phẩm sẽ được tải từ API -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editArticleContent" class="form-label">Nội dung <span
                                    class="text-danger">*</span></label>
                            <textarea id="editArticleContent" name="Description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editArticleStatus" class="form-label">Trạng thái <span
                                    class="text-danger">*</span></label>
                            <select id="editArticleStatus" name="Status" class="form-control">
                                <option value="0">Hoạt động</option>
                                <option value="1">Bị ẩn</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editArticleImage" class="form-label">Upload Image <span
                                    class="text-danger">*</span></label>
                            <input type="file" id="editArticleImage" name="file" accept="image/*" class="form-control">
                        </div>
                        <input type="hidden" id="editUserId" name="editUserId" value="1">
                        <button type="submit" class="btn btn-primary">Cập nhật</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Form tìm kiếm và bộ lọc -->
    <div class="mb-4">
        <div class="filter-container p-3">
            <div class="filter-row d-flex gap-2 align-items-center">
                <input type="text" class="form-control" id="searchName" placeholder="Tìm kiếm theo tiêu đề">

                <select class="form-control" id="articleCategoryFilter">
                    <option value="">Chọn thể loại bài viết</option>
                </select>

                <select class="form-control" id="searchStatus">
                    <option value="">Chọn trạng thái</option>
                    <option value="0">Hoạt động</option>
                    <option value="1">Bị ẩn</option>
                </select>


                <button class="btn btn-primary" id="searchBtn">Tìm Kiếm</button>
            </div>
        </div>
    </div>


    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th class="col-stt">STT</th>
                    <th class="col-title">Tiêu đề</th>
                    <th class="col-thumbnail">Ảnh thumbnail</th>
                    <th class="col-category">Thể loại bài viết</th>
                    <th class="col-status">Trạng thái</th>
                    <th class="col-date">Ngày tạo</th>
                    <th class="col-action">Hành Động</th>
                </tr>
            </thead>
            <tbody id="transportTableBody">
                <!-- Danh sách công ty vận chuyển sẽ được tải vào đây -->
            </tbody>
        </table>

        <div class="text-center mt-4" id="pagination">
            <!-- Phân trang sẽ được tải vào đây -->
        </div>

    </div>
    <div class="mb-4 text-right">
        <a href="managerDashboard.html" class="btn btn-secondary">Quay Lại Trang Chủ</a>
    </div>
    </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const itemsPerPage = 10;
        let currentPage = 1;

        function renderPaginationButtons(totalPages) {
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.add('btn', 'btn-primary', 'me-2');
                button.addEventListener('click', () => loadArticles(i));
                if (i === currentPage) {
                    button.classList.add('active');
                }
                paginationElement.appendChild(button);
            }
        }

        function loadArticles(pageNumber) {
            const searchName = document.getElementById('searchName').value;
            const serviceId = document.getElementById('articleCategoryFilter').value;
            const searchStatus = document.getElementById('searchStatus').value;
            let url = `https://localhost:7171/api/Article/GetAllArticle?pageNumber=${pageNumber}&pageSize=10`;
            currentPage = pageNumber;

            const params = new URLSearchParams();

            if (searchName) {
                params.append('name', searchName);
            }
            if (serviceId) {
                params.append('categoryId', serviceId);
            }
            if (searchStatus) {
                params.append('status', searchStatus);
            }

            if (params.toString()) {
                url += `&${params.toString()}`;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Accept': '*/*'
            };

            fetch(url, {
                method: 'GET',
                headers: headers
            })
                .then(response => response.json())
                .then(data => {
                    const articles = data.articles;
                    const paging = data.paging;
                    const tableBody = document.getElementById('transportTableBody');

                    tableBody.innerHTML = ''; // Clear existing rows

                    if (articles.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center">Không tìm thấy bài viết nào.</td></tr>`;
                        renderPaginationButtons(0); // No pagination if no products
                        return;
                    }

                    articles.forEach((article, index) => {
                        const pageSize = 12;
                        const serialNumber = (currentPage - 1) * pageSize + (index + 1);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                <td>${article.id}</td> 
                <td style="text-align: left;">${article.title}</td>
                <td>
                    <img src="https://localhost:7171/images/article/${article.image}" 
                        alt="${article.title}" 
                        class="img-fluid" 
                        style="width: 700px; height: 200px; border: 1px solid black;">
                </td>
                <td>${article.articleCategoryName}</td>
                <td>
                    ${article.status === 0
                                ? '<span style="color: green; font-weight: bold;">Hoạt động</span>'
                                : '<span style="color: red; font-weight: bold;">Bị ẩn</span>'
                            }
                </td>
                <td>${new Date(article.createdAt).toLocaleDateString()}</td>
                <td>
                    <div class="action-btns">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Hành động
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="showProductModal(${article.id})">Xem</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="editProduct(${article.id})">Sửa</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="deleteProduct(${article.id})">Xóa</a></li>
                            </ul>
                        </div>
                    </div>
                </td>
            `;
                        tableBody.appendChild(row);
                    });

                    // Render pagination buttons
                    renderPaginationButtons(paging.totalPageCount);
                })
                .catch(() => alert("Không tìm thấy bài viết nào."));
        }


        loadArticles(1);

        // Gán sự kiện click cho nút tìm kiếm
        document.getElementById('searchBtn').addEventListener('click', function () {
            loadArticles(1); // Gọi hàm với trang hiện tại
        });

        // Hàm để load danh sách dịch vụ từ API vào dropdown (filter)
        function loadArticleCategory2() {
            fetch('https://localhost:7171/api/ArticleCategory/GetAll', {
                method: 'GET',
                headers: {
                    'Accept': '*/*'
                }
            })
                .then(response => response.json()) // Chuyển đổi phản hồi từ API thành JSON
                .then(data => {
                    const serviceDropdown = document.getElementById('articleCategoryFilter');

                    // Xóa tất cả các option cũ trong dropdown
                    serviceDropdown.innerHTML = '<option value="">Chọn thể loại bài viết</option>';

                    // Duyệt qua dữ liệu và thêm các dịch vụ vào dropdown
                    data.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id; // Gán giá trị là ID của dịch vụ
                        option.textContent = category.name; // Hiển thị tên dịch vụ
                        serviceDropdown.appendChild(option); // Thêm option vào dropdown
                    });
                })
                .catch(error => {
                    console.error('Có lỗi xảy ra khi gọi API:', error);
                });
        }

        // Gọi hàm loadServices khi trang được tải
        loadArticleCategory2();

        function loadArticleCategory1() {
            fetch('https://localhost:7171/api/ArticleCategory/GetAll', {
                method: 'GET',
                headers: {
                    'Accept': '*/*'
                }
            })
                .then(response => response.json()) // Chuyển đổi phản hồi từ API thành JSON
                .then(data => {
                    const serviceDropdown = document.getElementById('articleCategory');

                    // Xóa tất cả các option cũ trong dropdown
                    serviceDropdown.innerHTML = '<option value="">Chọn thể loại bài viết</option>';

                    // Duyệt qua dữ liệu và thêm các dịch vụ vào dropdown
                    data.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id; // Gán giá trị là ID của dịch vụ
                        option.textContent = category.name; // Hiển thị tên dịch vụ
                        serviceDropdown.appendChild(option); // Thêm option vào dropdown
                    });
                })
                .catch(error => {
                    console.error('Có lỗi xảy ra khi gọi API:', error);
                });
        }
        loadArticleCategory1();

        function loadArticleCategory3() {
            fetch('https://localhost:7171/api/ArticleCategory/GetAll', {
                method: 'GET',
                headers: {
                    'Accept': '*/*'
                }
            })
                .then(response => response.json()) // Chuyển đổi phản hồi từ API thành JSON
                .then(data => {
                    const serviceDropdown = document.getElementById('editArticleCategory');

                    // Xóa tất cả các option cũ trong dropdown
                    serviceDropdown.innerHTML = '<option value="">Chọn thể loại bài viết</option>';

                    // Duyệt qua dữ liệu và thêm các dịch vụ vào dropdown
                    data.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id; // Gán giá trị là ID của dịch vụ
                        option.textContent = category.name; // Hiển thị tên dịch vụ
                        serviceDropdown.appendChild(option); // Thêm option vào dropdown
                    });
                })
                .catch(error => {
                    console.error('Có lỗi xảy ra khi gọi API:', error);
                });
        }
        loadArticleCategory3();

        




        



        //end của domcontent loaded
    });


    // async function submitForm() {
    //         const form = document.getElementById('addCompanyForm');
    //         const formData = new FormData(form);

    //         // Update the Description field with the content from TinyMCE
    //         const descriptionContent = tinymce.get('description').getContent();
    //         formData.set('Description', descriptionContent);

    //         try {
    //             const response = await fetch('https://localhost:7171/api/Product/addProduct', {
    //                 method: 'POST',
    //                 body: formData
    //             });

    //             if (response.ok) {
    //                 alert('Product added successfully!');
    //                 form.reset(); // Reset the form after successful submission
    //                 tinymce.get('description').setContent(''); // Clear TinyMCE content
    //             } else {
    //                 const error = await response.json();
    //                 alert('Error: ' + JSON.stringify(error.errors));
    //             }
    //         } catch (error) {
    //             console.error('Error:', error);
    //             alert('Failed to add product.');
    //         }
    //     }

    async function submitForm() {
        const form = document.getElementById('addCompanyForm');
        const formData = new FormData();

        // Lấy dữ liệu từ các input fields
        const articleTitle = document.getElementById('articleTitle').value;
        const articleContent = tinymce.get('articleContent').getContent();
        const articleStatus = document.getElementById('articleStatus').value;
        const articleImage = document.getElementById('articleImage').files[0];
        const articleCategory = document.getElementById('articleCategory').value;
        const userId = document.getElementById('userId').value;

        // Thêm dữ liệu vào formData
        formData.append('Title', articleTitle);
        formData.append('Content', articleContent);
        formData.append('Status', articleStatus);
        formData.append('file', articleImage);
        formData.append('ArticleCategoryId', articleCategory);
        formData.append('UserId', userId);

        try {
            const response = await fetch('https://localhost:7171/api/Article/addArticle', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('Bài viết đã được thêm thành công!');
                form.reset(); // Reset form sau khi thành công
                tinymce.get('articleContent').setContent(''); // Xóa nội dung TinyMCE
                // Đóng modal sau khi cập nhật thành công
                var modal = bootstrap.Modal.getInstance(document.getElementById('addCompanyModal'));
                modal.hide();
                location.reload();
            } else {
                const error = await response.json();
                alert('Lỗi: ' + JSON.stringify(error.errors));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Thêm bài viết thất bại.');
        }
    }


    function showProductModal(companyId) {
        // Lấy token từ localStorage
        const token = localStorage.getItem('accessToken'); // Đảm bảo key đúng

        fetch(`https://localhost:7171/api/Article/GetArticleById/${companyId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,  // Thêm token vào header
                'Content-Type': 'application/json',
                'Accept': '*/*'
            }
        })
            .then(response => response.json())
            .then(data => {
                // Cập nhật nội dung modal với dữ liệu từ API
                document.getElementById('titleById').textContent = data.title;
                document.getElementById('articleCategoryById').textContent = data.articleCategoryName;
                // document.getElementById('productStatus').textContent = data.status;

                const productStatus = document.getElementById('statusById');
                if (data.status === 0) {
                    productStatus.innerHTML = '<span style="color: green; font-weight: bold;">Đang kinh doanh</span>';
                } else {
                    productStatus.innerHTML = '<span style="color: red; font-weight: bold;">Ngừng kinh doanh</span>';
                }

                // Cập nhật ảnh sản phẩm
                const productImage = document.getElementById('articleThumbnail');
                productImage.src = `https://localhost:7171/images/article/${data.image}`; // Thêm đường dẫn ảnh từ API
                productImage.alt = data.title; // Đặt alt cho ảnh

                // Đặt kích thước cố định cho ảnh
                productImage.style.width = '700px';  // Đặt chiều rộng cố định
                productImage.style.height = '500px'; // Đặt chiều cao cố định
                productImage.style.objectFit = 'cover';  // Đảm bảo ảnh không bị méo

                // Cập nhật mô tả sản phẩm trong TinyMCE
                const productDescription = document.getElementById('articleContentById');
                productDescription.value = data.content; // Gán nội dung mô tả vào textarea

                // Tái khởi tạo TinyMCE với nội dung mô tả và readonly
                tinymce.init({
                    selector: '#articleContentById',
                    menubar: false,
                    toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright',
                    plugins: 'lists link image',
                    readonly: true // Đảm bảo rằng người dùng không thể chỉnh sửa
                    
                });
                tinymce.get('articleContentById').setContent(data.content);

                // Hiển thị modal
                var modal = new bootstrap.Modal(document.getElementById('companyModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Có lỗi khi tải thông tin bài viết:', error);
                alert('Không thể tải thông tin bài viết. Vui lòng thử lại.');
            });
    }   

    function editProduct(productId) {
        const token = localStorage.getItem('accessToken'); // Lấy token từ localStorage

        // Fetch thông tin sản phẩm
        fetch(`https://localhost:7171/api/Article/GetArticleById/${productId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            }
        })
            .then(response => response.json())
            .then(data => {
                // Load thông tin vào form

                document.getElementById('editArticleId').value = data.id;
                document.getElementById('editArticleTitle').value = data.title;
                document.getElementById('editArticleCategory').value = data.articleCategoryId; // Cập nhật ID của loại sản phẩm
                // tinymce.get('description').setContent(data.description); 
                document.getElementById('editArticleStatus').value = data.status;

                const articleContent = document.getElementById('editArticleContent');
                articleContent.value = data.content; // Gán nội dung mô tả vào textarea

                // Tái khởi tạo TinyMCE với nội dung mô tả và readonly
                tinymce.init({
                    selector: '#editArticleContent',
                    menubar: false,
                    toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright',
                    plugins: 'lists link image',
                    readonly: false // Đảm bảo rằng người dùng không thể chỉnh sửa
                });
                tinymce.get('editArticleContent').setContent(data.content);


                // Hiển thị modal
                var modal = new bootstrap.Modal(document.getElementById('editCompanyModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Có lỗi khi tải thông tin sản phẩm:', error);
                alert('Không thể tải thông tin sản phẩm. Vui lòng thử lại.');
            });
    }

    // document.getElementById('editCompanyForm').addEventListener('submit', function (event) {
    //     event.preventDefault(); // Ngăn chặn form gửi mặc định

    //     const productId = document.getElementById('editProductId').value;
    //     const productName = document.getElementById('editProductName').value;
    //     const productCategory = document.getElementById('editProductCategory').value;
    //     const productDescription = tinymce.get('editProductDescription').getContent();
    //     const productStatus = document.getElementById('status').value;

    //     // Lấy file ảnh
    //     const fileInput = document.getElementById('file');
    //     const formData = new FormData();
    //     formData.append('CategoryId', productCategory);
    //     formData.append('Name', productName);
    //     formData.append('Description', productDescription);
    //     formData.append('Status', productStatus);

    //     // Kiểm tra nếu có file ảnh mới, nếu có thì thêm vào FormData
    //     if (fileInput.files.length > 0) {
    //         formData.append('file', fileInput.files[0]);
    //     }

    //     const token = localStorage.getItem('accessToken');
    //     fetch(`https://localhost:7171/api/Product/updateProduct/${productId}`, {
    //         method: 'PUT',
    //         headers: {
    //             'Authorization': `Bearer ${token}`,
    //         },
    //         body: formData
    //     })
    //         .then(response => {
    //             if (!response.ok) {
    //                 throw new Error('Lỗi từ server: ' + response.statusText); // Xử lý lỗi nếu HTTP response không thành công
    //             }
    //             return response.json();
    //         })
    //         .then(data => {
    //             if (data.success) {
    //                 alert('Cập nhật sản phẩm thành công!');
    //                 location.reload(); // Tải lại trang hoặc cập nhật lại danh sách sản phẩm
    //             } else {
    //                 alert('Có lỗi khi cập nhật sản phẩm.');
    //             }
    //         })
    //         .catch(error => {
    //             console.error('Có lỗi khi cập nhật sản phẩm:', error);
    //             alert('Không thể cập nhật sản phẩm. Vui lòng thử lại.');
    //         });
    // });

    function updateProduct() {
        const token = localStorage.getItem('accessToken'); // Lấy token từ localStorage
        const productId = document.getElementById('editArticleId').value; // Lấy ID sản phẩm
        const formData = new FormData();

        // Thêm thông tin sản phẩm vào formData
        formData.append('Title', document.getElementById('editArticleTitle').value);
        formData.append('ArticleCategoryId', document.getElementById('editArticleCategory').value);
        formData.append('Content', tinymce.get('editArticleContent').getContent()); // Lấy nội dung mô tả từ TinyMCE
        formData.append('Status', document.getElementById('editArticleStatus').value);
        formData.append('UserId', document.getElementById('editUserId').value);

        const fileInput = document.getElementById('editArticleImage');

        // Nếu có file, thêm vào formData
        if (fileInput.files.length > 0) {
            formData.append('file', fileInput.files[0]);
        }

        // Gửi yêu cầu PUT đến API
        fetch(`https://localhost:7171/api/Article/updateArticle/${productId}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                console.log('Dữ liệu trả về từ API:', data); // In ra dữ liệu trả về để kiểm tra

                if (data.message) {
                    alert(data.message); // Hiển thị thông báo thành công hoặc lỗi từ API
                } else {
                    alert('Cập nhật bài viết thành công!');

                }

                // Đóng modal sau khi cập nhật thành công
                var modal = bootstrap.Modal.getInstance(document.getElementById('editCompanyModal'));
                modal.hide();
                location.reload();
            })
            .catch(error => {
                console.error('Có lỗi xảy ra:', error);
                alert('Đã xảy ra lỗi khi cập nhật bài viết!');
            });
    }






    // Gắn sự kiện submit cho form
    document.getElementById('editCompanyForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Ngừng gửi form mặc định
        updateProduct(); // Gọi hàm updateProduct để gửi yêu cầu PUT
    });

    function deleteProduct(companyId) {
        // Lấy token từ localStorage
        const token = localStorage.getItem('accessToken');
        if (confirm("Bạn có chắc chắn muốn xóa bài viết này?")) {
            fetch(`https://localhost:7171/api/Article/deleteArticle/${companyId}`, {
                method: 'DELETE',
                headers: {
                    'Accept': '*/*',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('Bài viết đã được xóa thành công!');
                        // Cập nhật lại danh sách công ty hoặc reload trang
                        // window.location.href = 'http://127.0.0.1:5500/transportCompany.html';
                        location.reload();
                    } else {
                        alert('Xóa bài viết thất bại!');
                    }
                })
        }
    }










    // document.getElementById('downloadCSVButton').addEventListener('click', function () {
    //     const apiUrl = 'https://localhost:7214/api/TransportCompany/GetCSVFile';
    //     const token = localStorage.getItem('accessToken');  // Lấy token từ localStorage

    //     if (!token) {
    //         alert('Vui lòng đăng nhập!');
    //         return;
    //     }

    //     fetch(apiUrl, {
    //         method: 'GET',
    //         headers: {
    //             'Authorization': `Bearer ${token}`,
    //             'Accept': '*/*',
    //         }
    //     })
    //         .then(response => {
    //             if (!response.ok) {
    //                 throw new Error('Không thể tải file CSV');
    //             }
    //             return response.blob(); // Nhận phản hồi dưới dạng blob
    //         })
    //         .then(blob => {
    //             const url = window.URL.createObjectURL(blob);
    //             const a = document.createElement('a');
    //             a.href = url;
    //             a.download = 'Danh_sach_cong_ty_van_chuyen.csv';
    //             document.body.appendChild(a);
    //             a.click();
    //             a.remove();
    //         })
    //         .catch(error => {
    //             console.error('Error:', error);
    //             alert('Có lỗi xảy ra khi tải file CSV!');
    //         });
    // });
    // Khi người dùng nhấn nút "Tải File CSV"
    document.getElementById("downloadCSVBtn").addEventListener("click", function () {
        const provinceId = document.getElementById("provinceCSV").value;
        const districtId = document.getElementById("districtCSV").value;
        const token = localStorage.getItem('accessToken');
        // Xây dựng URL API với các tham số provinceId và districtId
        const apiUrl = `https://localhost:7214/api/TransportCompany/GetCSVFileModify?provinceId=${provinceId}&districtId=${districtId}`;

        // Gọi API và tải file CSV
        fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Accept': 'application/csv',
                'Authorization': `Bearer ${token}`
                // Nếu cần token, hãy thêm vào headers:
                // 'Authorization': 'Bearer ' + 'YOUR_ACCESS_TOKEN_HERE'
            }
        })
            .then(response => response.blob())  // Lấy file dạng blob
            .then(blob => {
                // Tạo một liên kết để tải file
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "Danh_sach_cong_ty_van_chuyen.csv";  // Tên file tải về
                link.click();  // Mô phỏng click để tải file
            })
            .catch(error => {
                alert('Có lỗi xảy ra khi tải file!');
                console.error(error);
            });
    });


</script>

</body>

</html>